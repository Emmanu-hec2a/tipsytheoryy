{% extends 'custom_admin/base.html' %}
{% load static %}

{% block title %}Liquor Orders - Tipsy Theoryy Admin{% endblock %}

{% block page_title %}Liquor Order Management{% endblock %}

{% block breadcrumb_active %}Liquor Orders{% endblock %}

{% block extra_css %}
<style>
  /* ‚îÄ‚îÄ Payment Badge Colours ‚îÄ‚îÄ */
  .payment-badge {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 0.72rem;
    font-weight: 600;
    letter-spacing: 0.4px;
    text-transform: uppercase;
  }
  .payment-badge.paid       { background: #d1fae5; color: #065f46; }
  .payment-badge.pending    { background: #fef3c7; color: #92400e; }
  .payment-badge.failed     { background: #fee2e2; color: #991b1b; }
  .payment-badge.refunded   { background: #ede9fe; color: #5b21b6; }
  .payment-badge.cod        { background: #e0f2fe; color: #0369a1; }

  /* ‚îÄ‚îÄ M-Pesa Modal ‚îÄ‚îÄ */
  #mpesaModal .modal-content {
    border: none;
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 25px 60px rgba(0,0,0,.18);
  }

  #mpesaModal .modal-header {
    background: linear-gradient(135deg, #00b300 0%, #007a00 100%);
    padding: 22px 28px;
    border: none;
  }

  #mpesaModal .modal-header .modal-title {
    color: #fff;
    font-weight: 700;
    font-size: 1.1rem;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  #mpesaModal .modal-header .btn-close {
    filter: brightness(0) invert(1);
    opacity: .8;
  }

  /* M-Pesa logo strip */
  .mpesa-logo-strip {
    background: #f0fdf4;
    border-bottom: 1px solid #bbf7d0;
    padding: 12px 28px;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .mpesa-logo-strip .mpesa-logo-text {
    font-size: 1.4rem;
    font-weight: 900;
    color: #00b300;
    letter-spacing: -1px;
    font-family: 'Georgia', serif;
  }
  .mpesa-logo-strip .mpesa-logo-text span { color: #cc0000; }
  .mpesa-logo-strip small {
    color: #6b7280;
    font-size: 0.75rem;
  }

  /* Detail grid */
  .mpesa-detail-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 14px;
    padding: 24px 28px;
  }
  .mpesa-detail-item {
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    padding: 14px 16px;
  }
  .mpesa-detail-item.full-width {
    grid-column: 1 / -1;
  }
  .mpesa-detail-item .detail-label {
    font-size: 0.72rem;
    font-weight: 600;
    color: #9ca3af;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 5px;
  }
  .mpesa-detail-item .detail-value {
    font-size: 0.95rem;
    font-weight: 700;
    color: #111827;
    word-break: break-all;
  }
  .mpesa-detail-item .detail-value.amount {
    font-size: 1.4rem;
    color: #00b300;
  }
  .mpesa-detail-item .detail-value.highlight {
    font-family: 'Courier New', monospace;
    color: #4f46e5;
    font-size: 1rem;
  }

  /* Status pill inside modal */
  .mpesa-status-pill {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 5px 14px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 700;
  }
  .mpesa-status-pill.status-completed { background: #d1fae5; color: #065f46; }
  .mpesa-status-pill.status-pending   { background: #fef3c7; color: #92400e; }
  .mpesa-status-pill.status-failed    { background: #fee2e2; color: #991b1b; }

  /* Timeline */
  .mpesa-timeline {
    padding: 0 28px 24px;
  }
  .mpesa-timeline h6 {
    font-size: 0.78rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #9ca3af;
    font-weight: 700;
    margin-bottom: 14px;
  }
  .timeline-item {
    display: flex;
    gap: 14px;
    margin-bottom: 14px;
  }
  .timeline-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    margin-top: 5px;
    flex-shrink: 0;
    background: #d1d5db;
  }
  .timeline-dot.active { background: #00b300; }
  .timeline-dot.failed { background: #ef4444; }
  .timeline-content .tl-title {
    font-size: 0.85rem;
    font-weight: 600;
    color: #374151;
  }
  .timeline-content .tl-time {
    font-size: 0.75rem;
    color: #9ca3af;
  }

  /* Action row */
  .mpesa-modal-actions {
    padding: 0 28px 24px;
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }
  .btn-mpesa-resend {
    background: linear-gradient(135deg, #00b300, #007a00);
    color: #fff;
    border: none;
    border-radius: 10px;
    padding: 9px 20px;
    font-weight: 600;
    font-size: 0.85rem;
    display: flex;
    align-items: center;
    gap: 7px;
    transition: opacity .2s;
  }
  .btn-mpesa-resend:hover { opacity: .88; color: #fff; }

  .btn-mpesa-verify {
    background: #f3f4f6;
    color: #374151;
    border: 1px solid #e5e7eb;
    border-radius: 10px;
    padding: 9px 20px;
    font-weight: 600;
    font-size: 0.85rem;
    display: flex;
    align-items: center;
    gap: 7px;
    transition: background .2s;
  }
  .btn-mpesa-verify:hover { background: #e5e7eb; }

  .btn-mpesa-refund {
    background: #fff5f5;
    color: #dc2626;
    border: 1px solid #fecaca;
    border-radius: 10px;
    padding: 9px 20px;
    font-weight: 600;
    font-size: 0.85rem;
    display: flex;
    align-items: center;
    gap: 7px;
    transition: background .2s;
  }
  .btn-mpesa-refund:hover { background: #fee2e2; }

  /* table tweaks */
  #ordersTable th { white-space: nowrap; }
  .order-items small { line-height: 1.6; }

  /* loading shimmer for verify */
  @keyframes shimmer { 0%{opacity:1}50%{opacity:.5}100%{opacity:1} }
  .verifying { animation: shimmer 1s infinite; pointer-events: none; }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="mb-0" style="color: #2d3748;">üç∑ Liquor Order Management</h4>
    <div class="d-flex gap-2">
        <select class="form-select" id="statusFilter" onchange="filterOrders()">
            <option value="all"             {% if status_filter == 'all' %}selected{% endif %}>All Orders</option>
            <option value="pending"         {% if status_filter == 'pending' %}selected{% endif %}>Pending</option>
            <option value="confirmed"       {% if status_filter == 'confirmed' %}selected{% endif %}>Confirmed</option>
            <option value="preparing"       {% if status_filter == 'preparing' %}selected{% endif %}>Preparing</option>
            <option value="ready"           {% if status_filter == 'ready' %}selected{% endif %}>Ready</option>
            <option value="out_for_delivery"{% if status_filter == 'out_for_delivery' %}selected{% endif %}>Out for Delivery</option>
            <option value="delivered"       {% if status_filter == 'delivered' %}selected{% endif %}>Delivered</option>
            <option value="cancelled"       {% if status_filter == 'cancelled' %}selected{% endif %}>Cancelled</option>
        </select>
        <button class="btn btn-outline-primary" onclick="refreshOrders()">
            <i class="fas fa-sync-alt me-1"></i>Refresh
        </button>
    </div>
</div>

<!-- ‚îÄ‚îÄ Orders Table ‚îÄ‚îÄ -->
<div class="admin-card">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0" id="ordersTable">
                <thead class="table-light">
                    <tr>
                        <th>Order #</th>
                        <th>Customer</th>
                        <th>Items</th>
                        <th>Total</th>
                        <th>Payment</th>  <!-- ‚Üê NEW COLUMN -->
                        <th>Status</th>
                        <th>Time</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="ordersTableBody">
                    {% for order in orders %}
                    <tr data-order-id="{{ order.id }}">
                        <td>
                            <strong class="text-primary">{{ order.order_number }}</strong>
                        </td>
                        <td>
                            <div>
                                <strong>{{ order.user.username }}</strong><br>
                                <small class="text-muted">{{ order.user.phone_number }}</small>
                            </div>
                        </td>
                        <td>
                            <div class="order-items">
                                {% for item in order.items.all %}
                                <div class="mb-1">
                                    <small>{{ item.quantity }}x {{ item.food_item.name }} ({{ item.food_item.bottle_size }})</small>
                                </div>
                                {% endfor %}
                            </div>
                        </td>
                        <td>
                            <strong>KES {{ order.total|floatformat:0 }}</strong>
                        </td>

                        <!-- ‚îÄ‚îÄ Payment cell ‚îÄ‚îÄ -->
                        <td>
                            {% if order.mpesa_transactions %}
                                {% with p=order.mpesa_transactions %}
                                {% if p.payment_status == 'completed' %}
                                    <span class="payment-badge paid">
                                        <i class="fas fa-check-circle"></i> Paid
                                    </span>
                                {% elif p.payment_status == 'failed' %}
                                    <span class="payment-badge failed">
                                        <i class="fas fa-times-circle"></i> Failed
                                    </span>
                                <!-- {% elif p.status == 'refunded' %}
                                    <span class="payment-badge refunded">
                                        <i class="fas fa-undo"></i> Refunded
                                    </span> -->
                                {% else %}
                                    <span class="payment-badge pending">
                                        <i class="fas fa-clock"></i> Pending
                                    </span>
                                {% endif %}
                                <br>
                                <small class="text-muted mt-1 d-block">M-Pesa</small>
                                {% endwith %}
                            {% elif order.payment_method == 'cod' %}
                                <span class="payment-badge cod">
                                    <i class="fas fa-money-bill-wave"></i> COD
                                </span>
                            {% else %}
                                <span class="payment-badge pending">
                                    <i class="fas fa-clock"></i> Unpaid
                                </span>
                            {% endif %}
                        </td>
                        <!-- ‚îÄ‚îÄ /Payment cell ‚îÄ‚îÄ -->

                        <td>
                            <span class="badge status-{{ order.status }} fs-6">{{ order.get_status_display }}</span>
                        </td>
                        <td>
                            <small>{{ order.created_at|date:"M d, H:i" }}</small>
                            {% if order.estimated_delivery %}
                            <br><small class="text-muted">Est: {{ order.estimated_delivery|date:"H:i" }}</small>
                            {% endif %}
                        </td>

                        <!-- ‚îÄ‚îÄ Actions ‚îÄ‚îÄ -->
                        <td>
                            <div class="btn-group" role="group">
                                <a href="{% url 'admin_order_detail' order.order_number %}" class="btn btn-sm btn-outline-primary" title="View order">
                                    <i class="fas fa-eye"></i>
                                </a>

                                <!-- M-Pesa button (shown when payment exists OR order is not COD) -->
                                {% if order.payment_method != 'cod' %}
                                <button class="btn btn-sm btn-outline-success"
                                        title="M-Pesa Payment Details"
                                        onclick="openMpesaModal('{{ order.order_number }}')">
                                    <i class="fas fa-mobile-alt"></i>
                                </button>
                                {% endif %}

                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                        <i class="fas fa-cog"></i>
                                    </button>
                                    <ul class="dropdown-menu">
                                        {% if order.status == 'pending' %}
                                        <li><a class="dropdown-item" href="#" onclick="updateOrderStatus('{{ order.order_number }}', 'confirmed')">
                                            <i class="fas fa-check text-success me-2"></i>Confirm Order
                                        </a></li>
                                        {% endif %}
                                        {% if order.status == 'confirmed' %}
                                        <li><a class="dropdown-item" href="#" onclick="updateOrderStatus('{{ order.order_number }}', 'preparing')">
                                            <i class="fas fa-utensils text-warning me-2"></i>Start Preparing
                                        </a></li>
                                        {% endif %}
                                        {% if order.status == 'preparing' %}
                                        <li><a class="dropdown-item" href="#" onclick="updateOrderStatus('{{ order.order_number }}', 'ready')">
                                            <i class="fas fa-check-circle text-info me-2"></i>Mark Ready
                                        </a></li>
                                        {% endif %}
                                        {% if order.status == 'ready' %}
                                        <li><a class="dropdown-item" href="#" onclick="updateOrderStatus('{{ order.order_number }}', 'out_for_delivery')">
                                            <i class="fas fa-truck text-primary me-2"></i>Out for Delivery
                                        </a></li>
                                        {% endif %}
                                        {% if order.status == 'out_for_delivery' %}
                                        <li><a class="dropdown-item" href="#" onclick="updateOrderStatus('{{ order.order_number }}', 'delivered')">
                                            <i class="fas fa-box-open text-success me-2"></i>Mark Delivered
                                        </a></li>
                                        {% endif %}
                                        {% if order.status not in 'delivered,cancelled' %}
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item text-danger" href="#" onclick="cancelOrder('{{ order.order_number }}')">
                                            <i class="fas fa-times me-2"></i>Cancel Order
                                        </a></li>
                                        {% endif %}
                                    </ul>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="text-center py-5">
                            <i class="fas fa-wine-bottle fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No liquor orders found</h5>
                            <p class="text-muted">Liquor orders will appear here once customers start placing them.</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>


<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     M-PESA PAYMENT DETAILS MODAL
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal fade" id="mpesaModal" tabindex="-1" aria-labelledby="mpesaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" style="max-width:520px;">
        <div class="modal-content">

            <!-- Header -->
            <div class="modal-header">
                <h5 class="modal-title" id="mpesaModalLabel">
                    <i class="fas fa-mobile-alt"></i>
                    M-Pesa Payment Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <!-- Logo strip -->
            <div class="mpesa-logo-strip">
                <div class="mpesa-logo-text">M-<span>PESA</span></div>
                <div>
                    <div style="font-weight:700;font-size:.85rem;color:#374151;">Safaricom M-Pesa</div>
                    <small>Mobile Money Transaction</small>
                </div>
                <div class="ms-auto" id="mpesaStatusBadge">
                    <!-- filled by JS -->
                </div>
            </div>

            <!-- Loading state -->
            <div id="mpesaLoading" class="text-center py-5" style="display:none;">
                <div class="spinner-border text-success" role="status"></div>
                <p class="text-muted mt-3 mb-0">Fetching payment details‚Ä¶</p>
            </div>

            <!-- No payment state -->
            <div id="mpesaNoPayment" style="display:none;">
                <div class="text-center py-4 px-4">
                    <i class="fas fa-receipt fa-3x text-muted mb-3" style="opacity:.4;"></i>
                    <h6 class="text-muted">No M-Pesa transaction found</h6>
                    <p class="text-muted small mb-0">Payment has not been initiated or is still pending.</p>
                </div>
                <div class="mpesa-modal-actions justify-content-center">
                    <button class="btn-mpesa-resend" id="btnResendStk" onclick="resendStkPush()">
                        <i class="fas fa-paper-plane"></i> Resend STK Push
                    </button>
                </div>
            </div>

            <!-- Payment details (filled dynamically) -->
            <div id="mpesaDetails" style="display:none;">
                <div class="mpesa-detail-grid">
                    <div class="mpesa-detail-item full-width">
                        <div class="detail-label">Amount Paid</div>
                        <div class="detail-value amount" id="mpesaAmount">‚Äî</div>
                    </div>
                    <div class="mpesa-detail-item">
                        <div class="detail-label">Transaction ID (Receipt)</div>
                        <div class="detail-value highlight" id="mpesaReceiptNo">‚Äî</div>
                    </div>
                    <div class="mpesa-detail-item">
                        <div class="detail-label">Checkout Request ID</div>
                        <div class="detail-value highlight" id="mpesaCheckoutId">‚Äî</div>
                    </div>
                    <div class="mpesa-detail-item">
                        <div class="detail-label">Phone Number</div>
                        <div class="detail-value" id="mpesaPhone">‚Äî</div>
                    </div>
                    <div class="mpesa-detail-item">
                        <div class="detail-label">Order Reference</div>
                        <div class="detail-value" id="mpesaOrderRef">‚Äî</div>
                    </div>
                    <div class="mpesa-detail-item">
                        <div class="detail-label">Transaction Date</div>
                        <div class="detail-value" id="mpesaDate">‚Äî</div>
                    </div>
                    <div class="mpesa-detail-item">
                        <div class="detail-label">Result Description</div>
                        <div class="detail-value" id="mpesaResultDesc">‚Äî</div>
                    </div>
                </div>

                <!-- Timeline -->
                <div class="mpesa-timeline">
                    <h6>Transaction History</h6>
                    <div id="mpesaTimeline">
                        <!-- filled by JS -->
                    </div>
                </div>

                <!-- Actions -->
                <div class="mpesa-modal-actions">
                    <button class="btn-mpesa-verify" id="btnVerify" onclick="verifyPayment()">
                        <i class="fas fa-search-dollar"></i> Verify with Safaricom
                    </button>
                    <button class="btn-mpesa-resend" id="btnResend2" onclick="resendStkPush()" style="display:none;">
                        <i class="fas fa-paper-plane"></i> Resend STK Push
                    </button>
                    <button class="btn-mpesa-refund" id="btnRefund" onclick="initiateRefund()" style="display:none;">
                        <i class="fas fa-undo-alt"></i> Initiate Refund
                    </button>
                </div>
            </div>

        </div>
    </div>
</div>


<!-- ‚îÄ‚îÄ Order Status Update Modal ‚îÄ‚îÄ -->
<div class="modal fade" id="statusUpdateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Update Liquor Order Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="statusUpdateForm">
                    <div class="mb-3">
                        <label for="statusNotes" class="form-label">Notes (optional)</label>
                        <textarea class="form-control" id="statusNotes" rows="3" placeholder="Add any notes about this status update..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmStatusUpdate">Update Status</button>
            </div>
        </div>
    </div>
</div>

<!-- ‚îÄ‚îÄ Cancel Order Modal ‚îÄ‚îÄ -->
<div class="modal fade" id="cancelOrderModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Cancel Liquor Order</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to cancel this liquor order? This action cannot be undone.</p>
                <div class="mb-3">
                    <label for="cancelReason" class="form-label">Reason for cancellation</label>
                    <select class="form-select" id="cancelReason">
                        <option value="Customer requested">Customer requested</option>
                        <option value="Items unavailable">Items unavailable</option>
                        <option value="Age verification failed">Age verification failed</option>
                        <option value="Payment issue">Payment issue</option>
                        <option value="Technical issue">Technical issue</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="cancelNotes" class="form-label">Additional notes (optional)</label>
                    <textarea class="form-control" id="cancelNotes" rows="2" placeholder="Any additional information..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Keep Order</button>
                <button type="button" class="btn btn-danger" id="confirmCancelOrder">Cancel Order</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% block extra_js %}
<script>
    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    Shared state
    ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    let currentOrderNumber = null;
    let currentNewStatus = null;
    let currentMpesaData = null;   // cached payment data for the open modal

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    Order-list helpers
    ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    function filterOrders() {
        const status = document.getElementById('statusFilter').value;
        window.location.href = `?status=${status}`;
    }
    function refreshOrders() { window.location.reload(); }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    Order-status modal
    ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    function updateOrderStatus(orderNumber, newStatus) {
        currentOrderNumber = orderNumber;
        currentNewStatus = newStatus;
        new bootstrap.Modal(document.getElementById('statusUpdateModal')).show();
    }

    document.getElementById('confirmStatusUpdate').addEventListener('click', function () {
        const notes = document.getElementById('statusNotes').value;
        const button = this;
        const originalText = showLoading(button);

        fetch('/admin-panel/api/orders/update-status/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
            body: JSON.stringify({ order_number: currentOrderNumber, status: currentNewStatus, notes })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) { showAlert(data.message, 'success'); setTimeout(() => location.reload(), 1000); }
            else              { showAlert('Failed to update order status', 'danger'); }
        })
        .catch(() => showAlert('Error updating order status', 'danger'))
        .finally(() => {
            hideLoading(button, originalText);
            bootstrap.Modal.getInstance(document.getElementById('statusUpdateModal')).hide();
        });
    });

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    Cancel-order modal
    ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    function cancelOrder(orderNumber) {
        currentOrderNumber = orderNumber;
        new bootstrap.Modal(document.getElementById('cancelOrderModal')).show();
    }

    document.getElementById('confirmCancelOrder').addEventListener('click', function () {
        const reason = document.getElementById('cancelReason').value;
        const notes = document.getElementById('cancelNotes').value;
        const button = this;
        const originalText = showLoading(button);

        fetch('/admin-panel/api/orders/cancel/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
            body: JSON.stringify({ order_number: currentOrderNumber, reason: reason + (notes ? ': ' + notes : '') })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) { showAlert(data.message, 'success'); setTimeout(() => location.reload(), 1000); }
            else              { showAlert('Failed to cancel order', 'danger'); }
        })
        .catch(() => showAlert('Error cancelling order', 'danger'))
        .finally(() => {
            hideLoading(button, originalText);
            bootstrap.Modal.getInstance(document.getElementById('cancelOrderModal')).hide();
        });
    });

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    M-PESA MODAL LOGIC
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

    /** Open the M-Pesa modal and fetch payment data */
    function openMpesaModal(orderNumber) {
        currentOrderNumber = orderNumber;
        currentMpesaData   = null;

        // Reset state
        document.getElementById('mpesaLoading').style.display   = 'block';
        document.getElementById('mpesaNoPayment').style.display = 'none';
        document.getElementById('mpesaDetails').style.display   = 'none';
        document.getElementById('mpesaStatusBadge').innerHTML   = '';

        new bootstrap.Modal(document.getElementById('mpesaModal')).show();

        fetch(`/admin-panel/api/orders/mpesa-details/?order_number=${orderNumber}`, {
            headers: { 'X-CSRFToken': getCSRFToken() }
        })
        .then(r => r.json())
        .then(data => {
            document.getElementById('mpesaLoading').style.display = 'none';
            if (data.success && data.payment) {
                currentMpesaData = data.payment;
                renderMpesaDetails(data.payment);
            } else {
                document.getElementById('mpesaNoPayment').style.display = 'block';
            }
        })
        .catch(() => {
            document.getElementById('mpesaLoading').style.display   = 'none';
            document.getElementById('mpesaNoPayment').style.display = 'block';
            showAlert('Could not load payment details', 'danger');
        });
    }

    /** Populate the modal with real payment data */
    function renderMpesaDetails(p) {
        // Status badge
        const statusMap = {
            completed : { cls: 'status-completed', icon: 'fa-check-circle',  label: 'Completed' },
            pending   : { cls: 'status-pending',   icon: 'fa-clock',          label: 'Pending'   },
            failed    : { cls: 'status-failed',    icon: 'fa-times-circle',   label: 'Failed'    },
        };
        const s = statusMap[p.status] || statusMap['pending'];
        document.getElementById('mpesaStatusBadge').innerHTML =
            `<span class="mpesa-status-pill ${s.cls}"><i class="fas ${s.icon}"></i> ${s.label}</span>`;

        // Fields
        document.getElementById('mpesaAmount').textContent     = `KES ${Number(p.amount).toLocaleString('en-KE', {minimumFractionDigits:2})}`;
        document.getElementById('mpesaReceiptNo').textContent  = p.mpesa_receipt_number  || '‚Äî';
        document.getElementById('mpesaCheckoutId').textContent = p.checkout_request_id   || '‚Äî';
        document.getElementById('mpesaPhone').textContent      = p.phone_number           || '‚Äî';
        document.getElementById('mpesaOrderRef').textContent   = p.order_number           || currentOrderNumber;
        document.getElementById('mpesaDate').textContent       = p.transaction_date
            ? new Date(p.transaction_date).toLocaleString('en-KE', { dateStyle:'medium', timeStyle:'short' })
            : '‚Äî';
        document.getElementById('mpesaResultDesc').textContent = p.result_description     || '‚Äî';

        // Timeline
        const timeline = buildTimeline(p);
        document.getElementById('mpesaTimeline').innerHTML = timeline;

        // Action buttons
        const failed  = p.status === 'failed';
        const success = p.status === 'completed';
        document.getElementById('btnResend2').style.display = failed  ? 'flex' : 'none';
        document.getElementById('btnRefund').style.display  = success ? 'flex' : 'none';

        document.getElementById('mpesaDetails').style.display = 'block';
    }

    /** Build timeline HTML from payment object */
    function buildTimeline(p) {
        const events = [
            { label: 'STK Push Initiated', time: p.created_at,          done: true   },
            { label: 'Customer Prompted',  time: p.prompt_time,          done: !!p.prompt_time },
            { label: 'Payment Received',   time: p.transaction_date,     done: p.status === 'completed', failed: false },
            { label: 'Callback Received',  time: p.callback_received_at, done: !!p.callback_received_at, failed: p.status === 'failed' },
        ];
        return events.map(e => {
            const dotClass = e.failed ? 'failed' : (e.done ? 'active' : '');
            const timeStr  = e.time ? new Date(e.time).toLocaleTimeString('en-KE', {hour:'2-digit', minute:'2-digit'}) : '';
            return `
            <div class="timeline-item">
                <div class="timeline-dot ${dotClass}"></div>
                <div class="timeline-content">
                    <div class="tl-title">${e.label}</div>
                    ${timeStr ? `<div class="tl-time">${timeStr}</div>` : ''}
                </div>
            </div>`;
        }).join('');
    }

    /* ‚îÄ‚îÄ Verify payment with Safaricom ‚îÄ‚îÄ */
    function verifyPayment() {
        const btn = document.getElementById('btnVerify');
        btn.classList.add('verifying');
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verifying‚Ä¶';

        fetch('/admin-panel/api/mpesa/verify/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
            body: JSON.stringify({ order_number: currentOrderNumber })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                showAlert('Payment verified successfully with Safaricom ‚úì', 'success');
                if (data.payment) renderMpesaDetails(data.payment);
            } else {
                showAlert(data.message || 'Verification failed', 'warning');
            }
        })
        .catch(() => showAlert('Error contacting Safaricom', 'danger'))
        .finally(() => {
            btn.classList.remove('verifying');
            btn.innerHTML = '<i class="fas fa-search-dollar"></i> Verify with Safaricom';
        });
    }

    /* ‚îÄ‚îÄ Resend STK push ‚îÄ‚îÄ */
    function resendStkPush() {
        fetch('/admin-panel/api/mpesa/resend-stk/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
            body: JSON.stringify({ order_number: currentOrderNumber })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) { 
                showAlert('STK push sent to customer's phone ‚úì', 'success'); 
            }
            else{ 
                showAlert(data.message || 'Failed to send STK push', 'danger');
            }
        })
        .catch(() => showAlert('Error sending STK push', 'danger'));
    }

    /* ‚îÄ‚îÄ Initiate refund ‚îÄ‚îÄ */
    function initiateRefund() {
        if (!confirm('Initiate an M-Pesa refund for this transaction? This cannot be undone.')) return;

        fetch('/admin-panel/api/mpesa/refund/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
            body: JSON.stringify({ order_number: currentOrderNumber })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                showAlert('Refund initiated successfully ‚úì', 'success');
                bootstrap.Modal.getInstance(document.getElementById('mpesaModal')).hide();
                setTimeout(() => location.reload(), 1500);
            } else {
                showAlert(data.message || 'Failed to initiate refund', 'danger');
            }
        })
        .catch(() => showAlert('Error initiating refund', 'danger'));
    }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    Auto-refresh (new orders check every 30s)
    ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    setInterval(() => {
        if (document.visibilityState !== 'visible') return;
        fetch('/admin-panel/api/orders/new/')
            .then(r => r.json())
            .then(data => {
                if (data.success && data.new_orders_count > 0) {
                    showAlert(`${data.new_orders_count} new liquor order(s) received!`, 'info');
                }
            })
            .catch(err => console.error('Error checking for new orders:', err));
    }, 30000);
    </script>
{% endblock %}