{% extends 'base.html' %}
{% load static %}

{% block title %}Checkout - Tipsy Theoryy{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h2 mb-1 text-dark"><i class="fas fa-credit-card text-primary me-2"></i>Luxury Checkout</h1>
            <p class="text-muted mb-0">Complete your order with our premium checkout experience</p>
        </div>
    </div>

    <div class="row g-4">
        <!-- Order Summary -->
        <div class="col-lg-8">
            <div class="glassmorphism-card shadow-sm border-0 rounded-xl overflow-hidden mb-4">
                <div class="card-header text-white py-4 px-4" style="background: linear-gradient(135deg, #722f37, #DAA520);">
                    <h5 class="mb-0"><i class="fas fa-shopping-bag me-2"></i>Your Order</h5>
                </div>
                <div class="card-body">
                    <div id="checkoutItems" class="mb-4">
                        <!-- Items will be loaded here -->
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Total:</h5>
                        <h4 class="mb-0 text-primary" id="checkoutTotal">KES 0.00</h4>
                    </div>
                </div>
            </div>

            <!-- Delivery Information -->
            <div class="glassmorphism-card shadow-sm border-0 rounded-xl overflow-hidden mb-4">
                <div class="card-header text-white py-4 px-4" style="background: linear-gradient(135deg, #722f37, #DAA520);">
                    <h5 class="mb-0"><i class="fas fa-truck me-2"></i>Delivery Information</h5>
                </div>
                <div class="card-body">
                    <form id="deliveryForm">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Hostel</label>
                                <input type="text" class="form-control" id="hostel" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Room Number</label>
                                <input type="text" class="form-control" id="roomNumber" required>
                            </div>
                            <div class="col-12">
                                <label class="form-label fw-semibold">Delivery Instructions</label>
                                <textarea class="form-control" id="instructions" rows="3" placeholder="Any special instructions for delivery..."></textarea>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Payment Method -->
            <div class="glassmorphism-card shadow-sm border-0 rounded-xl overflow-hidden">
                <div class="card-header text-white py-4 px-4" style="background: linear-gradient(135deg, #722f37, #DAA520);">
                    <h5 class="mb-0"><i class="fas fa-credit-card me-2"></i>Payment Method</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-12">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="mpesa" value="mpesa" checked>
                                <label class="form-check-label fw-semibold" for="mpesa">
                                    <i class="fas fa-mobile-alt me-2 text-success"></i>M-Pesa
                                </label>
                            </div>
                            <small class="text-muted ms-4">Pay with M-Pesa for instant confirmation</small>
                        </div>
                        <div class="col-12">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="card" value="card">
                                <label class="form-check-label fw-semibold" for="card">
                                    <i class="fas fa-credit-card me-2 text-primary"></i>Credit/Debit Card
                                </label>
                            </div>
                            <small class="text-muted ms-4">Secure payment via card</small>
                        </div>
                    </div>

                    <!-- M-Pesa Section -->
                    <div id="mpesaSection" class="mt-4">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            You'll receive an M-Pesa prompt after placing your order.
                        </div>
                    </div>

                    <!-- Card Section (Hidden by default) -->
                    <div id="cardSection" class="mt-4 d-none">
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label fw-semibold">Card Number</label>
                                <input type="text" class="form-control" placeholder="1234 5678 9012 3456">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Expiry Date</label>
                                <input type="text" class="form-control" placeholder="MM/YY">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">CVV</label>
                                <input type="text" class="form-control" placeholder="123">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Order Summary Sidebar -->
        <div class="col-lg-4">
            <div class="glassmorphism-card shadow-sm border-0 rounded-xl overflow-hidden sticky-top" style="top: 20px;">
                <div class="card-header text-white py-4 px-4" style="background: linear-gradient(135deg, #722f37, #DAA520);">
                    <h5 class="mb-0"><i class="fas fa-receipt me-2"></i>Order Summary</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Subtotal:</span>
                            <span id="summarySubtotal">KES 0.00</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Delivery:</span>
                            <span class="text-success">FREE</span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between">
                            <strong>Total:</strong>
                            <strong class="text-primary" id="summaryTotal">KES 0.00</strong>
                        </div>
                    </div>

                    <button id="placeOrderBtn" class="btn btn-lg w-100 text-white mb-3" style="background: linear-gradient(135deg, #722f37, #DAA520); border: none;">
                        <i class="fas fa-check me-2"></i>Place Order
                    </button>

                    <div class="text-center">
                        <small class="text-muted">
                            <i class="fas fa-shield-alt me-1"></i>
                            Secure checkout with SSL encryption
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.glassmorphism-card {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.glassmorphism-card:hover {
    background: rgba(255, 255, 255, 0.15);
    transform: translateY(-2px);
    box-shadow: 0 12px 40px 0 rgba(31, 38, 135, 0.45);
}

[data-bs-theme="dark"] .glassmorphism-card {
    background: rgba(0, 0, 0, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.1);
}

[data-bs-theme="dark"] .glassmorphism-card:hover {
    background: rgba(0, 0, 0, 0.3);
}

.btn-loading {
    position: relative;
    color: transparent !important;
}

.btn-loading::after {
    content: "";
    position: absolute;
    width: 20px;
    height: 20px;
    top: 50%;
    left: 50%;
    margin-left: -10px;
    margin-top: -10px;
    border: 2px solid #ffffff;
    border-radius: 50%;
    border-top-color: transparent;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.form-check-input:checked {
    background-color: #722f37;
    border-color: #722f37;
}

.alert-info {
    background: rgba(13, 202, 240, 0.1);
    border-color: rgba(13, 202, 240, 0.2);
    color: #0dcaf0;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadCheckoutData();

    // Payment method toggle
    document.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const mpesaSection = document.getElementById('mpesaSection');
            const cardSection = document.getElementById('cardSection');

            if (this.value === 'mpesa') {
                mpesaSection.classList.remove('d-none');
                cardSection.classList.add('d-none');
            } else {
                mpesaSection.classList.add('d-none');
                cardSection.classList.remove('d-none');
            }
        });
    });

    // Place order
    document.getElementById('placeOrderBtn').addEventListener('click', placeOrder);
});

async function loadCheckoutData() {
    try {
        const response = await fetch('/api/cart/');
        const data = await response.json();

        if (data.success) {
            updateCheckoutUI(data);
        }
    } catch (error) {
        console.error('Error loading checkout data:', error);
    }
}

function updateCheckoutUI(data) {
    const checkoutItems = document.getElementById('checkoutItems');
    const checkoutTotal = document.getElementById('checkoutTotal');
    const summarySubtotal = document.getElementById('summarySubtotal');
    const summaryTotal = document.getElementById('summaryTotal');

    if (data.items.length === 0) {
        checkoutItems.innerHTML = '<p class="text-center text-muted">Your cart is empty</p>';
        return;
    }

    checkoutItems.innerHTML = data.items.map(item => `
        <div class="d-flex align-items-center mb-3 p-3 border rounded">
            <img src="${item.image || '/static/placeholder.jpg'}" alt="${item.name}"
                 class="img-thumbnail me-3" style="width: 60px; height: 60px; object-fit: cover;">
            <div class="flex-grow-1">
                <h6 class="mb-1">${item.name}</h6>
                <p class="mb-1 text-muted">KES ${item.price} x ${item.quantity}</p>
                <small class="text-muted">Subtotal: KES ${item.subtotal}</small>
            </div>
        </div>
    `).join('');

    checkoutTotal.textContent = `KES ${data.total}`;
    summarySubtotal.textContent = `KES ${data.total}`;
    summaryTotal.textContent = `KES ${data.total}`;
}

async function placeOrder() {
    const placeOrderBtn = document.getElementById('placeOrderBtn');
    const btnText = placeOrderBtn.querySelector('i') ? placeOrderBtn.innerHTML : '<i class="fas fa-check me-2"></i>Place Order';

    // Validate form
    const hostel = document.getElementById('hostel').value.trim();
    const roomNumber = document.getElementById('roomNumber').value.trim();

    if (!hostel || !roomNumber) {
        showAlert('Please fill in delivery information', 'danger');
        return;
    }

    // Show loading
    placeOrderBtn.classList.add('btn-loading');
    placeOrderBtn.innerHTML = '<span>Loading...</span>';

    const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
    const instructions = document.getElementById('instructions').value;

    try {
        const response = await fetch('/api/orders/create/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                hostel,
                room_number: roomNumber,
                payment_method: paymentMethod,
                delivery_instructions: instructions
            })
        });

        const data = await response.json();

        if (data.success) {
            if (paymentMethod === 'mpesa' && data.mpesa_checkout_url) {
                window.location.href = data.mpesa_checkout_url;
            } else {
                showAlert('Order placed successfully!', 'success');
                setTimeout(() => {
                    window.location.href = `/order/${data.order_number}/`;
                }, 2000);
            }
        } else {
            showAlert(data.message || 'Error placing order', 'danger');
            resetButton(placeOrderBtn, btnText);
        }
    } catch (error) {
        showAlert('Error placing order. Please try again.', 'danger');
        resetButton(placeOrderBtn, btnText);
    }
}

function resetButton(button, originalText) {
    button.classList.remove('btn-loading');
    button.innerHTML = originalText;
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);

    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
